name: Generate TWRP Device Tree from Recovery Image

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Device Name'
        required: true
        default: 'honor50se'
      manufacturer:
        description: 'Manufacturer'
        required: true
        default: 'honor'
      codename:
        description: 'Codename'
        required: true
        default: 'honor50se'
      recovery_image:
        description: 'Recovery Image File Name (in Images/ directory)'
        required: true
        default: 'recovery_a.img'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 步骤2：配置基础环境
      - name: 配置基础环境
        run: |
          echo "=== 配置基础环境 ==="
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip cpio file
          echo "✅ 基础工具安装完成"
      
      # 步骤3：安装 twrpdtgen
      - name: 安装 twrpdtgen
        run: |
          echo "=== 安装 twrpdtgen ==="
          python3 -m pip install twrpdtgen
          echo "✅ twrpdtgen 安装完成"
      
      # 步骤4：检查镜像文件
      - name: 检查镜像文件
        run: |
          echo "=== 检查镜像文件 ==="
          echo "Images 目录内容："
          ls -lh Images/
          
          IMAGE_FILE="Images/${{ github.event.inputs.recovery_image }}"
          echo "目标镜像文件: $IMAGE_FILE"
          
          if [ ! -f "$IMAGE_FILE" ]; then
            echo "❌ 错误：镜像文件不存在: $IMAGE_FILE"
            exit 1
          fi
          
          # 检查文件大小
          FILE_SIZE=$(stat -c%s "$IMAGE_FILE")
          if [ "$FILE_SIZE" -lt 1048576 ]; then
            echo "❌ 错误：镜像文件太小（$FILE_SIZE 字节）"
            exit 1
          fi
          
          echo "✅ 镜像文件存在，大小: $FILE_SIZE 字节"
          
          # 检查文件类型
          FILE_TYPE=$(file "$IMAGE_FILE")
          echo "文件类型: $FILE_TYPE"
      
      # 步骤5：生成设备树
      - name: 生成设备树
        run: |
          echo "=== 生成设备树 ==="
          
          # 尝试多个镜像文件，按优先级顺序
          IMAGE_FILES=(
            "Images/${{ github.event.inputs.recovery_image }}"
            "Images/recovery_a.img"
            "Images/recovery.img"
            "Images/boot_a.img"
            "Images/recovery_ramdisk_a.img"
          )
          
          SUCCESS=0
          
          for img in "${IMAGE_FILES[@]}"; do
            if [ -f "$img" ]; then
              echo "尝试使用镜像: $img"
              
              # 检查文件大小
              FILE_SIZE=$(stat -c%s "$img")
              echo "文件大小: $FILE_SIZE 字节"
              
              if [ "$FILE_SIZE" -lt 1048576 ]; then
                echo "⚠️  文件太小，跳过"
                continue
              fi
              
              # 检查文件类型
              FILE_TYPE=$(file "$img")
              echo "文件类型: $FILE_TYPE"
              
              # 尝试生成设备树
              echo "开始生成设备树..."
              python3 -m twrpdtgen "$img" 2>&1 | tee generation.log
              
              if [ $? -eq 0 ]; then
                echo "✅ 设备树生成成功！使用镜像: $img"
                SUCCESS=1
                break
              else
                echo "❌ 使用 $img 生成失败"
                if [ -f "generation.log" ]; then
                  echo "错误日志："
                  tail -50 generation.log
                fi
              fi
            else
              echo "⚠️  镜像文件不存在: $img"
            fi
            echo "---"
          done
          
          if [ $SUCCESS -eq 0 ]; then
            echo "❌ 所有镜像都尝试失败"
            exit 1
          fi
          
          # 列出生成的文件
          if [ -d "output" ]; then
            echo "output 目录内容："
            find output -type f
          else
            echo "⚠️  output 目录不存在"
            exit 1
          fi
          
          # 显示生成日志的最后部分
          if [ -f "generation.log" ]; then
            echo "生成日志（最后50行）："
            tail -50 generation.log
          fi
      
      # 步骤6：整理设备树文件
      - name: 整理设备树文件
        run: |
          echo "=== 整理设备树文件 ==="
          
          # 查找生成的设备树目录
          if [ -d "output" ]; then
            # 查找第一个生成的目录
            GENERATED_DIR=$(find output -type d -name "*" | head -1)
            
            if [ -n "$GENERATED_DIR" ]; then
              echo "找到生成的设备树目录: $GENERATED_DIR"
              
              # 移动到 device_tree 目录
              rm -rf device_tree
              mv "$GENERATED_DIR" device_tree
              
              echo "✅ 设备树文件已整理到 device_tree/"
              
              # 列出设备树内容
              echo "设备树文件列表："
              find device_tree -type f
            else
              echo "❌ 未找到生成的设备树目录"
              exit 1
            fi
          else
            echo "❌ output 目录不存在"
            exit 1
          fi
      
      # 步骤7：验证设备树
      - name: 验证设备树
        run: |
          echo "=== 验证设备树 ==="
          
          # 检查必要的文件
          REQUIRED_FILES=("Android.mk" "AndroidProducts.mk" "BoardConfig.mk" "device.mk")
          MISSING_FILES=()
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "device_tree/$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "⚠️  缺少必要的文件: ${MISSING_FILES[*]}"
            echo "这可能是正常的，取决于设备配置"
          else
            echo "✅ 所有必要文件都存在"
          fi
          
          # 显示设备树目录结构
          echo "设备树目录结构："
          tree device_tree -L 3 2>/dev/null || find device_tree -type f | head -20
      
      # 步骤8：上传设备树
      - name: 上传设备树
        uses: actions/upload-artifact@v4
        with:
          name: twrp-device-tree-${{ github.event.inputs.codename }}
          path: device_tree/
      
      # 步骤9：显示生成信息
      - name: 显示生成信息
        run: |
          echo "=== 设备树生成完成 ==="
          echo "设备名称: ${{ github.event.inputs.device_name }}"
          echo "制造商: ${{ github.event.inputs.manufacturer }}"
          echo "代号: ${{ github.event.inputs.codename }}"
          echo "使用的镜像: ${{ github.event.inputs.recovery_image }}"
          echo ""
          echo "设备树文件已上传到 Artifacts"
          echo "你可以从 Actions 页面下载生成的设备树"